 IAG and AL Results and Ratings Summary Report
 
Context and Background
We need to implement a new summary report format that recreates the "IAG and AL Results and Ratings" structure from the example Excel file. This report will be generated by our existing QA Analytics Framework and should integrate seamlessly with our current ValidationPipeline and ReportGenerator components.

Current System Architecture Context
Existing Components to Leverage:

ValidationPipeline (services/validation_service.py): Already generates structured validation results
ReportGenerator (reporting/generation/report_generator.py): Handles Excel and HTML report generation
RuleEvaluationResult: Contains per-rule compliance metrics and failing items
Responsible party grouping: Already supported via responsible_party_column parameter
Rule metadata: Severity, category, thresholds already stored in ValidationRule objects
Severity should map to risk level with the most severe being being 3, then 2, then 1

ValidationPipeline.validate_data_source() → 
rule_results (Dict[str, RuleEvaluationResult]) → 
ReportGenerator.generate_excel() → 
Standard compliance reports

Required Implementation: New IAG Summary Report
Target Report Structure (Based on Excel Analysis):
Section 1: IAG Overall Results and Rating (Rows 3-10)

IAG Overall Results and Rating
├── Total Score: [sum of all rule scores using IAG weighted formula]
├── GC Score: [sum of GC rule scores] 
├── PC Score: [sum of PC rule scores]
├── DNC Score: [sum of DNC rule scores]
├── Total Count of Applicable Tests Across Audit Leaders: [total rule count]
├── Weighted Score Across Audit Leaders: [IAG formula: (GC*5 + PC*3 + DNC*1) / (Total*5)]
├── Weighted Rating Across Audit Leaders: [GC/PC/DNC based on 80%/50% thresholds]
└── Override capabilities: [manual rating override + rationale fields]

Section 2: Audit Leader Overall Results and Ratings (2 rows of space below the end of Section 1)

Per Audit Leader:
├── Audit Leader Name
├── Per-rule results: [Rule 1 Title/Name, Rule 2 Title/Name, etc.]
├── Weighted Score: [IAG formula per leader: (GC*5 + PC*3 + DNC*1) / (Total*5)]
├── Weighted Average Rating: [GC ≥80%, PC 50-79%, DNC <50%]
├── Volume of Sampled Audit Entities by AL
└── Override fields: [Overridden AL Rating, Rating Override Rationale]

Section 3: Detailed Analytics Section (2 Rows below the end of Section 2)
Audit Leader Average Test Results:
├── Analytics metadata per rule:
│   ├── Analytic Error Threshold
│   ├── Risk Level (Weight 1-3)
│   ├── Rationale if out of scope
│   └── Analytic ID/Sub-Area
└── Per-leader detailed results:
    ├── Samples Tested for Audit Leader
    ├── Individual rule results (GC/PC/DNC per rule)
    ├── Summary counts: [GC Count, PC Count, DNC Count, Total Applicable Count]
    ├── Average Score: [percentage using IAG formula]
    └── Average Rating: [GC/PC/DNC based on IAG thresholds]


Critical Implementation Details: IAG Scoring Methodology
Configuration Values (Must be implemented exactly):
IAG_RATING_CONFIG = {
    'weights': {
        'GC': 5,    # Generally Conforms = 5 points
        'PC': 3,    # Partially Conforms = 3 points  
        'DNC': 1,   # Does Not Conform = 1 point
        'N/A': 0    # Not Applicable = 0 points
    },
    'thresholds': {
        'GC': 0.80,   # 80% threshold for Generally Conforms
        'PC': 0.50,   # 50% threshold for Partially Conforms (50-79%)
        'DNC': 0.00   # Below 50% = Does Not Conform
    }
}

Core IAG Scoring Formula (From Excel M31):

def calculate_iag_weighted_score(gc_count, pc_count, dnc_count, total_count):
    """
    Calculate weighted score using exact IAG methodology
    
    Excel Formula: ((GC*5) + (PC*3) + (DNC*1)) / (Total*5)
    
    Returns: Float between 0.0 and 1.0 representing percentage, or "N/A"
    """
    if total_count == 0:
        return "N/A"
    
    weighted_sum = (gc_count * 5) + (pc_count * 3) + (dnc_count * 1)
    max_possible_score = total_count * 5  # If all rules were GC
    
    return weighted_sum / max_possible_score

IAG Rating Assignment (From Excel N31):
def assign_iag_rating(weighted_score):
    """
    Assign rating based on IAG thresholds
    
    Excel Formula: IFS(score="N/A", "N/A", score>=80%, "GC", score<50%, "DNC", TRUE, "PC")
    """
    if weighted_score == "N/A":
        return "N/A"
    elif weighted_score >= 0.80:  # 80% or higher
        return "GC"
    elif weighted_score < 0.50:   # Below 50%
        return "DNC"
    else:                         # Between 50% and 79%
        return "PC"


Verified Calculation Examples:

All GC (1 GC, 0 PC, 0 DNC): Score = (1×5 + 0×3 + 0×1) / (1×5) = 1.0 (100%) → Rating = GC
All DNC (0 GC, 0 PC, 1 DNC): Score = (0×5 + 0×3 + 1×1) / (1×5) = 0.2 (20%) → Rating = DNC
Mixed (2 GC, 1 PC, 1 DNC): Score = (2×5 + 1×3 + 1×1) / (4×5) = 14/20 = 0.7 (70%) → Rating = PC

Implementation Requirements
1. New IAGScoringCalculator Class
Create dedicated calculator class:

class IAGScoringCalculator:
    """Implements IAG (Internal Audit Group) scoring methodology exactly as defined in Excel"""
    
    def __init__(self):
        self.rating_weights = {'GC': 5, 'PC': 3, 'DNC': 1, 'N/A': 0}
        self.rating_thresholds = {'GC': 0.80, 'PC': 0.50, 'DNC': 0.00}
    
    def calculate_leader_score(self, rule_results_for_leader):
        """Calculate weighted score and rating for a single audit leader"""
        
    def calculate_overall_iag_score(self, all_rule_results, responsible_party_column):
        """Calculate overall IAG score across all audit leaders"""
        
    def get_detailed_metrics_by_leader(self, rule_results, responsible_party_column):
        """Generate Section 3 detailed analytics per leader"""

2. Enhanced ReportGenerator Method
Create generate_iag_summary_excel() method:
Input Parameters:

results: Main validation results dictionary from ValidationPipeline
rule_results: Dictionary of RuleEvaluationResult objects keyed by rule_id
output_path: Target file path for Excel output
responsible_party_column: Column name for audit leader grouping
analytics_metadata: Optional dictionary with error thresholds, risk levels, analytic IDs
manual_overrides: Optional dictionary for manual rating overrides with rationales
review_year_name: String for header row (e.g., "2024 Q3 Compliance Review")

3. Data Processing Pipeline
def generate_iag_summary_excel(self, results, rule_results, output_path, 
                               responsible_party_column, **kwargs):
    """
    Generate IAG and AL Results and Ratings Excel report with exact formatting
    
    Processing Steps:
    1. Initialize IAGScoringCalculator
    2. Group rule results by audit leader (responsible party)
    3. Calculate IAG scores per leader using exact formula
    4. Calculate overall IAG score across all leaders  
    5. Generate Section 1: IAG Overall Results (rows 3-10)
    6. Generate Section 2: Audit Leader Results (rows 12-17+)
    7. Generate Section 3: Detailed Analytics (rows 20+)
    8. Export structured data to excel without any styling, merging, or formatting- just raw values in appropriate cells. 
    9. Save workbook and return path
      """
    
    # Step 1: Initialize calculator
    calculator = IAGScoringCalculator()
    
    # Step 2: Group results by audit leader
    leader_groups = self._group_results_by_leader(rule_results, responsible_party_column)
    
    # Step 3: Calculate scores per leader
    leader_scores = {}
    for leader, leader_rule_results in leader_groups.items():
        score, rating = calculator.calculate_leader_score(leader_rule_results)
        leader_scores[leader] = {'score': score, 'rating': rating, 'results': leader_rule_results}
    
    # Step 4: Calculate overall IAG metrics
    overall_metrics = calculator.calculate_overall_iag_score(rule_results, responsible_party_column)
    
    # Step 5-7: Generate Excel sections
    workbook = self._create_iag_excel_workbook(overall_metrics, leader_scores, **kwargs)
    
    # Step 8-9: Format and save
    return self._save_formatted_iag_workbook(workbook, output_path)

def generate_iag_summary_report(self, results, rule_results, 
                               responsible_party_column, 
                               output_path=None, **kwargs):
    """
    Convenience method to generate IAG summary from validation pipeline
    
    Args:
        results: Validation results from validate_data_source()
        rule_results: Rule evaluation results dictionary
        responsible_party_column: Column for audit leader grouping
        output_path: Optional output path (auto-generated if None)
        **kwargs: Additional options (analytics_metadata, manual_overrides, etc.)
    
    Returns:
        Path to generated IAG summary Excel file
    """
    if not output_path:
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        analytic_id = results.get('analytic_id', 'validation')
        output_path = self.output_dir / f"{analytic_id}_{timestamp}_IAG_Summary.xlsx"
    
    return self.report_generator.generate_iag_summary_excel(
        results=results,
        rule_results=rule_results,
        output_path=output_path,
        responsible_party_column=responsible_party_column,
        **kwargs
    )


Integration Test Cases:

Test with actual ValidationPipeline output
Test with multiple audit leaders and various rule combinations
Test Excel file structure validation against template
Test with edge cases (no data for some leaders, all N/A results)